#!/bin/sh -x

# configure script for yadkin

# TODO:
# Add the ability to change the JVM in use (>17)
# Add the ability to upgrade the Android build in use by default
# Perhaps replace the different Makefiles with one Makefile

# software name
NAME=yadkin
# version
VERSION=0.06
# prefix (libraries will be in the right place if installed globally and under this directory if it's supposed to be self-contained)
PREFIX="/usr/local"
# force os (NOTE: $OSTYPE is defined on Linux.  Wonder if it's the same for Mac and Windows?)
OSNAME=
# default company/developer name
COMPANY=itsamazing
# default program name
PROG=yadkin
# verbosity
VERBOSE=1
# choose specific versions of JDK, Android, iOS, etc
#VERS_JDK=
#VERS_SDL=
VERS_ANDROID=
VERS_IOS=
# format for configure-style messages
FMT="%-30s"
# The home of the dependencies so far
SRCURL=https://ramar.work/public/yadkin

# Dependencies we'll need to run this
TAR=/bin/tar
SED=/bin/sed
AWK=/bin/awk
GZIP=/bin/gzip
UNAME=/bin/uname

# NOTE: These can most definitely change, but they work w/ the newest versions of Gradle and Kotlin without fail
JDKBIN_LINUX="OpenJDK17U-jdk_x64_linux_hotspot_17.0.14_7.tar.gz"
JDKBIN_MAC="OpenJDK17U-jdk_x64_mac_hotspot_17.0.14_7.tar.gz"
JDKBIN_WIN="OpenJDK17U-jdk_x64_windows_hotspot_17.0.14_7.zip"

#if test $# -lt 1
#then
#	echo "$0: No args specified."
#	exit 1
#fi 

while [ $# -gt 0 ]
do
	case "$1" in

    # PREFIX for installed software
		-p|--prefix)
			shift
			PREFIX=$1
		;;

    # COMPANY is the organization identifier used for any new apps generated with this tool
		-c|--company)
			shift
			COMPANY=$1
		;;

    # Specify a JDK URL or version
    -j|--jdk)
    ;;

    # Specify the versions of Android you'd like present once this is complete
    -a|--android-builds)
    ;;

    # OS Detection should work, but this would override those rules 
		-o|--operating-system)
			shift
			OSNAME=$1
		;;

    # Print excess lines
		-v|--verbose)
			VERBOSE=1
		;;

		# Print no status messages
		--no-verbose)
			VERBOSE=0
		;;

    # ...  
		-h|--help)
			cat <<EOF
Usage: $0
-p, --prefix \$DIR             Specify an alternate directory to install
                              utilities.
-c, --company \$NAME           Specify a default identifier for your projects
                              (e.g. org.x.y for Android)
-o, --operating-system \$DIR   Specify an alternate directory to install
                              utilities.
-v, --verbose                 Explain everything   
-h, --help                    Show this help and quit
EOF
		;;
	esac
	shift
done


# Check for awk
test $VERBOSE -eq 1 && printf "$FMT" "checking for awk..."
if ! test -x "$AWK"
then
  # Try finding it via which
  if test "`which 2>/dev/null || echo $?`" -eq 127
  then
    echo "Dependency 'awk' not found."
    exit 1
  fi

  # Look for it
  AWK="`which awk`"
  if ! test -x "$AWK"
  then
    echo "Dependency 'awk' not found."
    exit 1
  fi 
  printf "Done!\n"
fi


# Check for sed
test $VERBOSE -eq 1 && printf "$FMT" "checking for sed..."
if ! test -x "$SED"
then
  # Try finding it via which
  if test "`which 2>/dev/null || echo $?`" -eq 127
  then
    echo "Dependency 'sed' not found."
    exit 1
  fi

  # Look for it
  SED="`which sed`"
  if ! test -x "$SED"
  then
    echo "Dependency 'sed' not found."
    exit 1
  fi 
  printf "Done!\n"
fi


# Check for tar
test $VERBOSE -eq 1 && printf "$FMT" "checking for tar..."
if ! test -x "$TAR"
then
  # Try finding it via which
  if test "`which 2>/dev/null || echo $?`" -eq 127
  then
    echo "Dependency 'tar' not found."
    exit 1
  fi

  # Look for it
  TAR="`which tar`"
  if ! test -x "$TAR"
  then
    echo "Dependency 'tar' not found."
    exit 1
  fi 
  printf "Done!\n"
fi


# Check for gzip (though it's rare that anyone uses this filter with tar) 
#test $VERBOSE -eq 1 && printf "$FMT" "checking for gzip..."
#if ! test -x "$GZIP"
#then
#  # Try finding it via which
#  if test "`which 2>/dev/null || echo $?`" -eq 127
#  then
#    echo "Dependency 'gzip' not found."
#    exit 1
#  fi
#
#  # Look for it
#  GZIP="`which gzip`"
#  if ! test -x "$GZIP"
#  then
#    echo "Dependency 'gzip' not found."
#    exit 1
#  fi 
#  printf "Done!\n"
#fi


# Check for uname
test $VERBOSE -eq 1 && printf "$FMT" "checking for uname..."
if ! test -x "$UNAME"
then
  # Try finding it via which
  if test "`which 2>/dev/null || echo $?`" -eq 127
  then
    echo "Dependency 'uname' not found."
    exit 1
  fi

  # Look for it
  UNAME="`which uname`"
  if ! test -x "$UNAME"
  then
    echo "Dependency 'uname' not found."
    exit 1
  fi 
  printf "Done!\n"
fi


# Quick, crude OS detection (or use the c/l override)
OSNAME=`$UNAME 2>/dev/null`
#if test -z "$OSNAME"
#then
#	echo "Operating system unspecified"
#	exit 1
#fi


# Dump any variables
if test $VERBOSE -eq 1
then
	cat <<EOF
Building yadkin with the following configuration:
PREFIX  = $PREFIX (The Android SDK, its dependencies and C tooling will be installed here)
COMPANY = $COMPANY (This is the default application identifier)
OSNAME  = $OSNAME (This is the operating system that will be built for)
EOF
fi


# Configure anything OS-specific
OSOPT=`echo $OSNAME | $AWK '{ print substr(tolower($1),1,1) }'`
if test -z "$OSOPT"
then
	echo Operating System is Unknown 
	exit 1
elif test $OSOPT == 'l'
then
	echo is Linux
	JDKBIN=$JDKBIN_LINUX
	MAKEFILE=Makefile.linux
	CONFIGFILE=unix.env
elif test $OSOPT == 'd'
then
	echo is Mac 
	JDKBIN=$JDKBIN_MAC
	MAKEFILE=Makefile.mac
	CONFIGFILE=macos.env
elif test $OSOPT == 'c'
then
	echo is Cyg 
	# TODO: Is this not Windows?
	JDKBIN=$JDKBIN_LINUX
	MAKEFILE=Makefile.cygwin
	CONFIGFILE=cygwin.env
else
	echo is Unknown 
	exit 1
fi


# Generate a Makefile
$SED "{
	s/@@COMPANY@@/$COMPANY/g;
	s/@@JDKBIN@@/$JDKBIN/g;
	s/@@OSNAME@@/$OSNAME/g;
	s#@@PREFIX@@#$PREFIX#g;
	s#@@SRCURL@@#$SRCURL#g;
	s/@@VERSION@@/$VERSION/g;
}" makefiles/${MAKEFILE}.in > Makefile


# Generate a environment file as well
$SED "{
	s#@@PREFIX@@#$PREFIX#g;
	s/@@COMPANY@@/$COMPANY/g;
	s/@@OSNAME@@/$OSNAME/g;
	s/@@JDKSRC@@/$JDKSRC/g;
}" environment/${CONFIGFILE}.in > yadkin-init.sh


exit 0
